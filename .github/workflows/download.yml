name: Download Docker Image to Tar

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'vllm/vllm-openai:v0.12.0'
        required: true
        default: 'vllm/vllm-openai:v0.12.0'

jobs:
  download:
    runs-on: ubuntu-latest
    steps:
      # 1. 手动清理磁盘空间 (不依赖插件，更稳定)
      - name: Free Disk Space (Manual)
        run: |
          echo "清理前空间:"
          df -h
          
          # 删除 .NET 运行环境 (约 1.5GB)
          sudo rm -rf /usr/share/dotnet
          
          # 删除 Android 开发环境 (约 10GB+)
          sudo rm -rf /usr/local/lib/android
          
          # 删除 Haskell 语言环境 (约 2GB)
          sudo rm -rf /opt/ghc
          
          # 删除 CodeQL 分析工具 (约 2GB)
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          
          # 清理 Docker 缓存 (删除预装的镜像)
          sudo docker system prune -a -f
          
          echo "清理后空间:"
          df -h

      # 2. 拉取镜像
      - name: Pull Image
        run: docker pull ${{ inputs.image_name }}

      # 3. 打包保存
      - name: Save Image to Tar
        run: |
          # 替换文件名中的特殊字符
          FILENAME=$(echo ${{ inputs.image_name }} | tr '/' '_' | tr ':' '_').tar
          echo "正在打包: $FILENAME ..."
          docker save -o $FILENAME ${{ inputs.image_name }}
          echo "FILENAME=$FILENAME" >> $GITHUB_ENV

      # 4. 上传结果
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: ${{ env.FILENAME }}
          retention-days: 1
